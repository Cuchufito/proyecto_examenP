{% extends 'base.html' %}

{% block titulo %}
Recepción de Vehículos
{% endblock %}

{% block contenido %}
<div class="container mt-4">
    <h3>Recepción de Vehículo</h3>

    <div class="card">

        <div class="card-body">
            <form id="formRecepcion">
                <div class="row">
                    <div class="col-md-6">
                        <h5>Datos del Cliente</h5>
                        <div class="form-group">
                            <label for="buscarCliente">Cliente:</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="buscarCliente" placeholder="Buscar cliente...">
                                <div class="input-group-append">
                                    <button class="btn btn-outline-secondary" type="button" id="btnBuscarCliente">Buscar</button>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="nombreCliente">Nombre:</label>
                            <input type="text" class="form-control" id="nombreCliente" readonly>
                        </div>
                        <div class="form-group">
                            <label for="telefonoCliente">Teléfono:</label>
                            <input type="text" class="form-control" id="telefonoCliente" readonly>
                        </div>
                        <div class="form-group">
                            <label for="direccionCliente">Dirección:</label>
                            <input type="text" class="form-control" id="direccionCliente" readonly>
                        </div>
                        <div class="form-group">
                            <label for="emailCliente">Email:</label>
                            <input type="email" class="form-control" id="emailCliente" readonly>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <h5>Datos del Vehículo</h5>
                        <div class="form-group">
                            <label for="buscarVehiculo">Matrícula:</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="buscarVehiculo" placeholder="Buscar vehículo...">
                                <div class="input-group-append">
                                    <button class="btn btn-outline-secondary" type="button" id="btnBuscarVehiculo">Buscar</button>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="marcaVehiculo">Marca:</label>
                            <input type="text" class="form-control" id="marcaVehiculo" readonly>
                        </div>
                        <div class="form-group">
                            <label for="modeloVehiculo">Modelo:</label>
                            <input type="text" class="form-control" id="modeloVehiculo" readonly>
                        </div>
                        <div class="form-group">
                            <label for="anioVehiculo">Año:</label>
                            <input type="text" class="form-control" id="anioVehiculo" readonly>
                        </div>
                        <div class="form-group">
                            <label for="colorVehiculo">Color:</label>
                            <input type="text" class="form-control" id="colorVehiculo" readonly>
                        </div>
                        <div class="form-group">
                            <label for="motivoTaller">Entra al taller para:</label>
                            <textarea class="form-control" id="motivoTaller" rows="2"></textarea>
                        </div>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-6">
                        <h5>Kilómetros y Combustible</h5>
                        <div class="form-group">
                            <label for="kilometraje">Kilómetros:</label>
                            <input type="number" class="form-control" id="kilometraje">
                        </div>
                        <div class="form-group">
                            <label for="nivelCombustible">Nivel de Combustible:</label>
                            <select class="form-control" id="nivelCombustible">
                                <option value="F">F (Full)</option>
                                <option value="3/4">3/4</option>
                                <option value="1/2">1/2</option>
                                <option value="1/4">1/4</option>
                                <option value="E">E (Empty)</option>
                            </select>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <h5>Inventario</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="gato">
                                    <label class="form-check-label" for="gato">Gato</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="tazasRuedas">
                                    <label class="form-check-label" for="tazasRuedas">Tazas de Ruedas</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="espejoIzquierdo">
                                    <label class="form-check-label" for="espejoIzquierdo">Espejo Izquierdo</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="extintor">
                                    <label class="form-check-label" for="extintor">Extintor</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="radio">
                                    <label class="form-check-label" for="radio">Radio</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="controlPuertas">
                                    <label class="form-check-label" for="controlPuertas">Control de Puertas</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="herramientas">
                                    <label class="form-check-label" for="herramientas">Herramientas</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="encendedor">
                                    <label class="form-check-label" for="encendedor">Encendedor</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="lucesInterior">
                                    <label class="form-check-label" for="lucesInterior">Luces de Interior</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="baliza">
                                    <label class="form-check-label" for="baliza">Baliza</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="pantalla">
                                    <label class="form-check-label" for="pantalla">Pantalla</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="senaleros">
                                    <label class="form-check-label" for="senaleros">Señaleros</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="alfombra">
                                    <label class="form-check-label" for="alfombra">Alfombra</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="cubreSol">
                                    <label class="form-check-label" for="cubreSol">Cubre Sol</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="forroAsientos">
                                    <label class="form-check-label" for="forroAsientos">Forro de Asientos</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="llantaRepuesto">
                                    <label class="form-check-label" for="llantaRepuesto">Llanta de Repuesto</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group mt-3">
                    <label for="observaciones">Observaciones:</label>
                    <textarea class="form-control" id="observaciones" rows="3"></textarea>
                </div>

                <div class="text-right mt-3">
                    <button type="button" class="btn btn-secondary" id="btnCancelar">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="btnGuardar">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para buscar clientes -->
<div class="modal fade" id="modalBuscarCliente" tabindex="-1" role="dialog" aria-labelledby="modalBuscarClienteLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalBuscarClienteLabel">Buscar Cliente</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <table class="table table-striped" id="tblClientes">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Teléfono</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal para buscar vehículos -->
<div class="modal fade" id="modalBuscarVehiculo" tabindex="-1" role="dialog" aria-labelledby="modalBuscarVehiculoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalBuscarVehiculoLabel">Buscar Vehículo</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <table class="table table-striped" id="tblVehiculos">
                    <thead>
                        <tr>
                            <th>Matrícula</th>
                            <th>Marca</th>
                            <th>Modelo</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block js %}
<script>
$(document).ready(function() {
    // Inicializar DataTables
    $('#tblClientes').DataTable({
        language: {
            url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}",
        },
        ajax: '/api/v1/clientes',
        columns: [
            { data: 'cliente_id' },
            { data: 'nombre' },
            { data: 'telefono' },
            { 
                data: null,
                render: function(data, type, row) {
                    return '<button class="btn btn-primary btn-seleccionar-cliente" data-id="' + row.cliente_id + '">Seleccionar</button>';
                }
            }
        ]
    });

    $('#tblVehiculos').DataTable({
        language: {
            url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}",
        },
        ajax: '/api/v1/vehiculos',
        columns: [
            { data: 'matricula' },
            { data: 'marca' },
            { data: 'modelo' },
            { 
                data: null,
                render: function(data, type, row) {
                    return '<button class="btn btn-primary btn-seleccionar-vehiculo" data-id="' + row.vehiculo_id + '">Seleccionar</button>';
                }
            }
        ]
    });

    // Mostrar modal de búsqueda de cliente
    $('#btnBuscarCliente').click(function() {
        $('#modalBuscarCliente').modal('show');
    });

    // Seleccionar cliente
    $('#tblClientes tbody').on('click', '.btn-seleccionar-cliente', function() {
        const data = $('#tblClientes').DataTable().row($(this).parents('tr')).data();
        $('#nombreCliente').val(data.nombre);
        $('#telefonoCliente').val(data.telefono);
        $('#direccionCliente').val(data.direccion);
        $('#emailCliente').val(data.email);
        $('#modalBuscarCliente').modal('hide');
    });

    // Mostrar modal de búsqueda de vehículo
    $('#btnBuscarVehiculo').click(function() {
        $('#modalBuscarVehiculo').modal('show');
    });

    // Seleccionar vehículo
    $('#tblVehiculos tbody').on('click', '.btn-seleccionar-vehiculo', function() {
        const data = $('#tblVehiculos').DataTable().row($(this).parents('tr')).data();
        $('#buscarVehiculo').val(data.matricula);
        $('#marcaVehiculo').val(data.marca);
        $('#modeloVehiculo').val(data.modelo);
        $('#anioVehiculo').val(data.año);
        $('#colorVehiculo').val(data.color);
        $('#modalBuscarVehiculo').modal('hide');
    });

    // Guardar recepción
    $('#formRecepcion').submit(function(e) {
        e.preventDefault();
        
        const recepcionData = {
            cliente_id: $('#tblClientes').DataTable().row('.selected').data().cliente_id,
            vehiculo_id: $('#tblVehiculos').DataTable().row('.selected').data().vehiculo_id,
            fecha_recepcion: new Date().toISOString().split('T')[0],
            motivo_ingreso: $('#motivoTaller').val(),
            kilometraje: $('#kilometraje').val(),
            nivel_combustible: $('#nivelCombustible').val(),
            porcentaje_combustible: $('#porcentajeCombustible').val(),
            observaciones: $('#observaciones').val(),
            inventario: {
                gato: $('#gato').is(':checked'),
                tazas_ruedas: $('#tazasRuedas').is(':checked'),
                espejo_izquierdo: $('#espejoIzquierdo').is(':checked'),
                extintor: $('#extintor').is(':checked'),
                radio: $('#radio').is(':checked'),
                control_puertas: $('#controlPuertas').is(':checked'),
                herramientas: $('#herramientas').is(':checked'),
                encendedor: $('#encendedor').is(':checked'),
                luces_interior: $('#lucesInterior').is(':checked'),
                baliza: $('#baliza').is(':checked'),
                pantalla: $('#pantalla').is(':checked'),
                señaleros: $('#senaleros').is(':checked'),
                alfombra: $('#alfombra').is(':checked'),
                cubre_sol: $('#cubreSol').is(':checked'),
                forro_asientos: $('#forroAsientos').is(':checked'),
                llanta_repuesto: $('#llantaRepuesto').is(':checked'),
                faros_luces: $('#farosLuces').is(':checked'),
                forro_volante: $('#forroVolante').is(':checked'),
                antena: $('#antena').is(':checked'),
                espejo_derecho: $('#espejoDerecho').is(':checked')
            }
        };

        fetch('/api/v1/recepciones', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(recepcionData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                Swal.fire('Éxito', 'Recepción registrada correctamente', 'success');
                $('#formRecepcion')[0].reset();
            } else {
                Swal.fire('Error', data.error || 'Error al registrar la recepción', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire('Error', 'Ocurrió un error al procesar la solicitud', 'error');
        });
    });
});
</script>
{% endblock %}